<!--
This file was generated by an automated scan of `handlers.py`.
It lists helper functions, FSM states, command and callback handlers
with the start and end line numbers in `handlers.py` (lines are 1-indexed).
-->
# handlers.py — Features & function locations

Repository file: `handlers.py`

Total lines in file: 1404

---

## Summary

This document lists the main helpers, FSM classes, command handlers and callback handlers found in `handlers.py`, plus the exact line ranges where each function is defined (start..end).

Notes:
- Line numbers are based on the current file in the workspace (1404 lines total).
- `async` functions and synchronous `def` functions are included.

---

## FSM State classes

- `MeetingStates` — lines 16..21
  - States: topic, date, time, confirm
- `ShortenerStates` — lines 24..30
  - States: waiting_for_url, waiting_for_provider, waiting_for_custom_choice, waiting_for_custom_url
- `RestoreStates` — lines 33..34
  - States: waiting_for_file

## Helper functions (utilities)

- `extract_zoom_meeting_id(url: str) -> Optional[str]` — lines 50..66
  - Extract a Zoom meeting ID from a join URL (matches `zoom.us/j/<digits>`).

- `_get_user_info_text(user: dict) -> str` — lines 67..71
  - Returns a formatted string showing telegram id, username, status and role.

- `_get_username_from_telegram_id(telegram_id: str) -> str` (async) — lines 72..88
  - Resolve a telegram id to a username (fetches from DB if numeric). Special-case `CreatedFromZoomApp`.

- `_format_meeting_time(start_time_str: str) -> str` — lines 89..129
  - Format ISO datetimes into Indonesian (WIB) day/month names and time.

- `_parse_indonesia_date(date_str: str) -> Optional[date]` — lines 130..177
  - Parse various Indonesian/English date formats such as `DD-MM-YYYY`, `DD/MM/YYYY`, and `DD Month YYYY`.

- `_parse_time_24h(time_str: str) -> Optional[time]` — lines 178..214
  - Parse 24-hour time formats (`HH:MM`, `H:MM`, `HHMM`) into `time` objects.

## Command handlers (message handlers)

- `cmd_whoami(msg: Message)` (async) — lines 215..233
  - `/whoami`: show sender telegram id, username and whether they match configured owner.

- `cmd_help(msg: Message)` (async) — lines 234..288
  - `/help`: display available commands, admin-only commands and features (localized Indonesian text).

- `cmd_about(msg: Message)` (async) — lines 289..302
  - `/about`: short description about the bot and version information.

- `cmd_zoom(msg: Message)` (async) — lines 303..487
  - `/meet`: create a Zoom meeting or create multiple meetings in batch. Supports quoted args per-line: `"topic" "date" "time"`.
  - Parses date/time with helper functions, creates meetings via Zoom client and stores them in DB; returns summary and, for successes, message(s) with shortcuts for creating short URLs.

- `cmd_sync_meetings(msg: Message)` (async) — lines 488..518
  - `/sync_meetings`: owner-only manual sync from Zoom to local DB; reports counts added/updated/deleted/expired/errors.

- `cmd_check_expired(msg: Message)` (async) — lines 519..546
  - `/check_expired`: owner-only check to mark meetings as expired and report stats.

- `cmd_register_list(msg: Message)` (async) — lines 547..658
  - `/register_list`: admin/owner-only, show pending users with pagination and action buttons (accept/reject/ban).

- `cmd_all_users(msg: Message)` (async) — lines 659..770
  - `/all_users`: admin/owner-only, list whitelisted and banned users with management buttons (manage/unban) and pagination.

- `cmd_start(msg: Message)` (async) — lines 771..821
  - `/start`: register user (auto-add owner as whitelisted if owner id matches) and show main UI depending on role/status.

- `cmd_backup(msg: Message, bot: Bot)` (async) — lines 1267..1302
  - `/backup`: owner-only, create backup zip containing DB dump and shortener config, send file to owner, clean up temp file.

- `cmd_restore(msg: Message, state: FSMContext)` (async) — lines 1303..1324
  - `/restore`: owner-only, enter restore mode and wait for a ZIP to be uploaded (FSM transition to RestoreStates.waiting_for_file).

- `handle_restore_file(msg: Message, state: FSMContext, bot: Bot)` (async) — lines 1325..1404
  - FSM handler for `RestoreStates.waiting_for_file`: validates ZIP, downloads file, extracts required files (`database_backup.sql`, `shorteners_backup.json`), calls restore routines, cleans up and replies with a success/failure summary.

## Utility / internal helper (message/callback editing)

- `_safe_edit_or_fallback(c: CallbackQuery, text: str, reply_markup=None, parse_mode=None)` (async) — lines 822..871
  - Attempts to edit the original message; if edit fails (e.g., message too old), falls back to reply() and finally to c.answer(). Used by callback handlers to refresh UIs safely.

## Callback handlers (callback_query)

- `cb_accept(c: CallbackQuery)` (async) — lines 872..894
  - `accept:<telegram_id>`: mark pending user as whitelisted and refresh `register_list` view.

- `cb_reject(c: CallbackQuery)` (async) — lines 895..919
  - `reject:<telegram_id>`: delete user entry and refresh `register_list` view.

- `cb_ban_toggle(c: CallbackQuery)` (async) — lines 920..945
  - `ban_toggle:<telegram_id>`: toggle ban/unban for a user and refresh the `all_users` view.

- `cb_ban(c: CallbackQuery)` (async) — lines 946..966
  - `ban:<telegram_id>`: ban a pending user and refresh the `register_list` view.

- `cb_unban(c: CallbackQuery)` (async) — lines 967..987
  - `unban:<telegram_id>`: unban a user and refresh the `all_users` view.

- `cb_manage_user(c: CallbackQuery)` (async) — lines 988..1010
  - `manage_user:<telegram_id>`: show management options for a specific user (role/status info and action buttons).

- `cb_register_list(c: CallbackQuery)` (async) — lines 1011..1138
  - `register_list` / `register_list:<page>`: Refresh paginated pending-users list (supports navigation buttons). Uses `_safe_edit_or_fallback`.

- `cb_noop(c: CallbackQuery)` (async) — lines 1139..1144
  - `noop`: used to clear loading state; simply answers callback.

- `cb_all_users(c: CallbackQuery)` (async) — lines 1145..1266
  - `all_users` / `all_users:<page>`: Refresh paginated all-users view (whitelisted + banned) and management buttons.

---

## Quick index (name -> start..end)

```
extract_zoom_meeting_id          : 50..66
_get_user_info_text             : 67..71
_get_username_from_telegram_id  : 72..88
_format_meeting_time            : 89..129
_parse_indonesia_date           : 130..177
_parse_time_24h                 : 178..214

cmd_whoami                      : 215..233
cmd_help                        : 234..288
cmd_about                       : 289..302
cmd_zoom (/meet)                : 303..487
cmd_sync_meetings               : 488..518
cmd_check_expired               : 519..546
cmd_register_list               : 547..658
cmd_all_users                   : 659..770
cmd_start                       : 771..821

_safe_edit_or_fallback          : 822..871

cb_accept                       : 872..894
cb_reject                       : 895..919
cb_ban_toggle                   : 920..945
cb_ban                          : 946..966
cb_unban                        : 967..987
cb_manage_user                  : 988..1010
cb_register_list                : 1011..1138
cb_noop                         : 1139..1144
cb_all_users                    : 1145..1266

cmd_backup                      : 1267..1302
cmd_restore                     : 1303..1324
handle_restore_file             : 1325..1404
```

## Notes & small observations

- The file is heavily localized in Indonesian; UI text, help and prompts are in Indonesian.
- Pagination for user lists uses a fixed `users_per_page = 5` and supports simple previous/next navigation via callback data.
- Short URL workflow: batch `/meet` stores successful meeting entries in `TEMP_MEETINGS` with generated tokens and supplies `shorten:<token>` callback buttons.
- Several admin-only commands check `settings.owner_id` and/or `is_allowed_to_create`.

If you want, I can:
- Add this index into the existing `HANDLERS_DOCUMENTATION.md` (merge/update) instead of a separate file.
- Produce a machine-readable JSON file mapping names -> line ranges.

---

Generated on: 2025-10-28
