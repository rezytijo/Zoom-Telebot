name: Build Dev Image

on:
  push:
    branches:
      - "development"
  workflow_dispatch:

jobs:
  docker-build-dev:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate dev tag
        id: tag
        run: |
          DATE=$(date +%Y.%m.%d)
          DEV_TAG="dev.v$DATE"
          echo "dev_tag=$DEV_TAG" >> $GITHUB_OUTPUT

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            rezytijo/zoom-telebot
          tags: |
            type=raw,value=${{ steps.tag.outputs.dev_tag }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push dev image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Verify Docker image
        run: |
          DEV_TAG="${{ steps.tag.outputs.dev_tag }}"
          echo "Verifying dev image: rezytijo/zoom-telebot:$DEV_TAG"
          if ! docker pull --quiet rezytijo/zoom-telebot:$DEV_TAG > /dev/null 2>&1; then
            echo "Error: Failed to pull dev image from Docker Hub"
            exit 1
          else
            echo "Success: Dev image rezytijo/zoom-telebot:$DEV_TAG is available on Docker Hub"
          fi

      - name: Trigger Portainer Stack Update
        run: |
          echo "ðŸ”„ Triggering Portainer stack update via webhook..."
          WEBHOOK_URL="https://docker.primall.my.id/api/stacks/webhooks/85781723-51a0-455e-a538-c5a72cc31724"
          
          # Make POST request to Portainer webhook
          RESPONSE=$(curl -s -o response.txt -w "%{http_code}" -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions-Webhook")
          
          # Check response
          if [ "$RESPONSE" -eq 200 ] || [ "$RESPONSE" -eq 204 ]; then
            echo "âœ… Portainer webhook triggered successfully (HTTP $RESPONSE)"
            echo "ðŸš€ Stack update initiated in Portainer"
          else
            echo "âŒ Failed to trigger Portainer webhook (HTTP $RESPONSE)"
            echo "Response body:"
            cat response.txt 2>/dev/null || echo "No response body"
            exit 1
          fi